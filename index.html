<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <h1>EDAV FINAL PROJECT INTERACTIVE GRAPH</h1>
        <h3><i>Yadin Rozov and Kun Tao</i></h3>
        <h2>Introduction</h2>
        <p>The Federal Student Loan program is a key funding mechanism individuals in the United States use to pursue higher education. 
           The program has reportedly grown quickly in the last decade and now outstanding student loan balances make up the biggest component 
           of the Federal Governmentâ€™s balance sheet. We attempt to look at data to get a better understanding of this program and the 
           potential impact student lending could have on the borrowers and the broader economy.
        </p>
           
        </p>One of the key questions in our study is: what is the trend of the debt held by individuals from the perspective of 
            Age Demographics in the past decade? To answer this, we look at the annual debt data provided by the New York Fed, 
            which span from 2004 to 2017 and are across five age groups: under 30, 30 to 39, 40 to 49, 50 to 59 and older than 
            60 years old. We normalize the debt levels to GDP with nominal GDP data from the World Bank and then further
            consolidate the data into <i>generations</i> by using <i>under 30</i> to represent the current <i>Millennials</i>, 
            <i>30-50</i> to represent <i>Gen-X</i> and <i>Over 50</i> to represent the <i>Baby-boomers</i>.
        </p>
        <p>
            <b><i>Two shocking results come out: First the percentage of debt held by people under 30 has gone down from 42.8% to 27% 
                  and second that debt load has been picked up by both the middle-age population who went from 47% to 53% and the population 
                  of people older than 50 almost doubled from 10% to 19%.
            </i></b>
        </p>
        
        <p>As one of the most significant findings of our EDAV Final Project, we deciede to share these two discoveries with the public
           by visualizing them interactively and publishing the animated graphs on the internet.
        </p>
        
        <h2>Interactive Data Visualizations with D3.js</h2>
        
        <p>Here we use D3.js to build the following easy-to-use, dynamic and interactive chart to show the trend of the Debt Held 
           by Each Generation from 2004 to 2017.
        <p>
        <p>The time series of the percentage of the total debt held by each age group are represented by different colors: orange for
           <i>people between 30 and 50</i>, blue for <i>people under 30</i> and green for <i>people above 50</i>. There is a 
           <i>Draw Time Series</i> button on the top left corner of the graph system. After you click it for the first time,
           three group of dots will pop up with each dot denoting the percent of total debt held by a specific group in a
           specific year. Then, three lines will pass through each group of dots to show the trends in a more intuitive way.
           Near the end of each line or each group of dots, there will be a label in the same color to tell you which group
           the line and/or dots represent. If you want to see the number of percentage that a specific dot represents, just 
           mouse over it, then a tooltip will pop up to show you all the information you might be interested, meanwhile, the
           dot of interest will zoom in, and then back to its original size once you move your mouse out of it. In addition, the
           <i>Draw Time Series</i> button can be clicked as multiple times as you want, the only difference from the first time
           you click it is: the lines will be re-drawn, but the dots and labels will stay there.
        <p>

        <h2>Technical Challenges of Our D3-based Interactive Visualizations</h2>   
        
            <p>As described in the above <b>Introduction</b> section, the orignal data used to draw this graph comes from the
               New York Fed, and has gone through a series of aggregation and normalization processing running by the code in
               our <i>EDAV Final Report.Rmd</i>. Initially, we had attempted to convert the dataframe produced by our
               <i>EDAV Final Report.Rmd</i> to a csv file, and then read in the csv file with D3 script to generate the
               desired interactive visualizations. However, this implementation encountered the problem of
               <i>Cross-Origin Request Blocked</i> with both Firefox and Google Chrome browsers. Briefly speaking, these two
               popular web browsers blocked the request from the D3 script to load the external csv file due to web security
               considerations. Therefore, we have to embed the dataset as an array of objects manually in our D3 script, which
               is pretty time-consuming. Otherwise, we would be able to publish more interactive visualizations for other interesting
               findings in our EDAV Final Report. One possible solution to this issue is to build a LAMP(Linux operating system, 
               Apache HTTP Server, MySQL relational database management system (RDBMS) and PHP programming language)-based
               web application. Thus, we will be able to store the processed datasets in the MySQL database, then render them 
               interactively through the User Interface of the web app.                              
            </p>
            <p>In addition, it is also desirable to put other functional buttons on the webpage in the future, like <i>Print</i>, 
            <i>Download</i>, and so on. Thus, if people who read this webpge like our findings, they can easily save the
               graph for future usage.            
            </p>
            
        <h2>References</h2>
        
        <p>1. Yadin Rozov and Kun Tao, <i>"EDAV Final Report"</i></p>
        <p>2. <a href="https://edav.info/project.html">Final Project Assignment</a> </p>
        <br></br>
        
        
        <script src="https://d3js.org/d3.v4.min.js"></script>
        
        <style>
            body {
                font-family: sans-serif;
            }
            
            button {
                border: none;
                font-size: 20px;
                background-color: lightblue;
                display: inline-block;
            }

            .axis { 
                font: 14px sans-serif; 
            }
            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }

            .line {
                fill:none;
                stroke: #6F257F;
                stroke-width: 5px;
            }
            
            .overlay {
                fill: none;
                pointer-events: all;
            }
            
            .hover-line {
                stroke: #B74779;
                stroke-width: 2px;
                stroke-dasharray: 3,3;
            }

            .x.axis path {
                display: inline;
            }

            .y.axis path {
                display: none;
            }
  
            .axis.y .tick line { 			
                stroke-width:1px; 			
                stroke:#ccc; 			
                stroke-opacity:1;	 		
            }
            
            #tooltip {
                position: absolute;
                width: 200px;
                height: auto;
                padding: 10px;
                background-color: gray;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
                font-weight: bold;
                -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                pointer-events: none;
            }
            
            #tooltip.hidden {
                display: none;
            }
            
            #tooltip p {
                margin: 0;
                font-family: Futura;
                font-size: 16px;
                line-height: 20px;
            }
        </style>
    </head>
    
    <body>
        <div id="controls">
            <button id="btnDebtPct">Draw Time Series</button>
        </div>
        
        <div id="chart"> </div>
        
        <div id="tooltip" class="hidden">
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function(){ 
                d3.selectAll("button").on("click",function(d, i){return animatelines(i);})
                makeChart();}, false);
                
            function makeChart()
            {
            var chartWidth = parseInt(d3.select("#chart").style("width"));

            var margin = {top: 40, right: 40, bottom: 40, left: 75};
            var outWidth = parseInt(chartWidth * 3 / 4);
            var outHeight = 400;
            
            var width = outWidth - margin.left - margin.right;
            var height = outHeight - margin.top - margin.bottom;
                
            var data = [{ "date": "2004",
                          "Percent of Total Debt by People under 30": "0.4287352",
                          "Percent of Total Debt by People between 30 and 50": "0.4673477",
                          "Percent of Total Debt by People above 50": "0.1039172"
                        }, 
                        { "date": "2005",
                          "Percent of Total Debt by People under 30": "0.4153338",
                          "Percent of Total Debt by People between 30 and 50": "0.4704299",
                          "Percent of Total Debt by People above 50": "0.1142362"
                        },
                        { "date": "2006",
                          "Percent of Total Debt by People under 30": "0.4079384",
                          "Percent of Total Debt by People between 30 and 50": "0.4666936",
                          "Percent of Total Debt by People above 50": "0.125368"
                        },
                        { "date": "2007",
                          "Percent of Total Debt by People under 30": "0.4022039",
                          "Percent of Total Debt by People between 30 and 50": "0.4655762",
                          "Percent of Total Debt by People above 50": "0.1322199"
                        },
                        { "date": "2008",
                          "Percent of Total Debt by People under 30": "0.3928113",
                          "Percent of Total Debt by People between 30 and 50": "0.469426",
                          "Percent of Total Debt by People above 50": "0.1377627"
                        },
                        { "date": "2009",
                          "Percent of Total Debt by People under 30": "0.3827158",
                          "Percent of Total Debt by People between 30 and 50": "0.4733223",
                          "Percent of Total Debt by People above 50": "0.1439619"
                        },
                        { "date": "2010",
                          "Percent of Total Debt by People under 30": "0.3713308",
                          "Percent of Total Debt by People between 30 and 50": "0.4803078",
                          "Percent of Total Debt by People above 50": "0.1483614"
                        },
                        { "date": "2011",
                          "Percent of Total Debt by People under 30": "0.3626444",
                          "Percent of Total Debt by People between 30 and 50": "0.4856141",
                          "Percent of Total Debt by People above 50": "0.1517415"
                        },
                        { "date": "2012",
                          "Percent of Total Debt by People under 30": "0.3345748",
                          "Percent of Total Debt by People between 30 and 50": "0.5054172",
                          "Percent of Total Debt by People above 50": "0.160008"
                        },
                        { "date": "2013",
                          "Percent of Total Debt by People under 30": "0.3355165",
                          "Percent of Total Debt by People between 30 and 50": "0.5025519",
                          "Percent of Total Debt by People above 50": "0.1619316"
                        },
                        { "date": "2014",
                          "Percent of Total Debt by People under 30": "0.3206729",
                          "Percent of Total Debt by People between 30 and 50": "0.5112376",
                          "Percent of Total Debt by People above 50": "0.1680895"
                        },
                        { "date": "2015",
                          "Percent of Total Debt by People under 30": "0.3057887",
                          "Percent of Total Debt by People between 30 and 50": "0.5183646",
                          "Percent of Total Debt by People above 50": "0.1758467"
                        },
                        { "date": "2016",
                          "Percent of Total Debt by People under 30": "0.2912424",
                          "Percent of Total Debt by People between 30 and 50": "0.526714",
                          "Percent of Total Debt by People above 50": "0.1820436"
                        },
                        { "date": "2017",
                          "Percent of Total Debt by People under 30": "0.2768464",
                          "Percent of Total Debt by People between 30 and 50": "0.5337285",
                          "Percent of Total Debt by People above 50": "0.1894251"
                        }
                       ]

                var xScale = d3.scaleTime().range([0, width - 250]);
                var xAxis = d3.axisBottom(xScale);

                var yScale = d3.scaleLinear().domain([0, 60]).range([height, 0]);
                var yAxis = d3.axisLeft(yScale).tickFormat(d3.format('.0f'));
                
                var line = d3.line().x(function(d) { return xScale(d.date); })
                                    .y(function(d) { return yScale(d.ratio * 100); });
            
                var svg = d3.select("#chart")
                .append("svg")
                .attr("class", "svgele") 
                .attr("id", "svgEle")  
                .attr("width", width + margin.left + margin.right) 
                .attr("height", height + margin.top + margin.bottom)
                .append("g") 
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
                var color = d3.scaleOrdinal(d3.schemeCategory10);
                color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));
            
                var parseTime = d3.timeParse("%Y");
                var circData = new Array();
                data.forEach(function(d) {
                    d.date = parseTime(d.date);
                    circData.push(["Percent of Total Debt by People under 30", d.date, d["Percent of Total Debt by People under 30"]],
                                  ["Percent of Total Debt by People between 30 and 50", d.date, d["Percent of Total Debt by People between 30 and 50"]],
                                  ["Percent of Total Debt by People above 50", d.date, d["Percent of Total Debt by People above 50"]])
                });
                
                
                projections = color.domain().map(function(name) {
                    return {
                        name: name,
                        values: data.map(function(d) {
                            return {date: d.date, ratio: d[name]}
                            })
                    };
                });
            
                xScale.domain(d3.extent(data, function(d) { return d.date; }));
            
                svg.append('g')
                .attr("class", "axis")
                .attr('transform', 'translate(0,' + height + ')')
                .call(xAxis);
                svg.append("text")          
                .attr("transform", "translate(" + ((width - 250) / 2) + " ," + (height + 40) + ")")
                .style("text-anchor", "middle")
                .text("Year");
            
                svg.append('g')
                .attr("class", "axis")
                .call(yAxis); 
                svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -(height / 2))
                .attr("y", -(margin.left - 25))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Percent"); 
                
                projections = projections.filter(function(d){ return d.values.length > 0; });
                var proj = svg.selectAll(".proj")
                .data(projections)
                .enter()
                .append("g")
                .attr("class", "proj");
            
                proj.append("path")
                .attr("class", "line")
                .attr("id" , function(d, i){
                        return "line" + i;
                     })
                .attr("stroke-linecap","round")
                .attr("d", function(d, i) {
                        return line(d.values);
                     })
                .style("stroke", function(d) { return color(d.name); });
                
                
                var legendData = new Array()
                projections.forEach(function (d) {
                    var temp2 = d.values;
                    legendData.push([d.name, temp2[13].date, temp2[13].ratio])
                });
                
                var tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");
  
                proj.selectAll("circle")
                .data(circData)
                .enter()
                .append("circle")
                .attr("class", "circ")
                .attr("id" , function(d, i){
                        return "circ" + i;
                     })
                .attr("cx", d => xScale(d[1]))
                .attr("cy", d => yScale(d[2] * 100))
                .attr("fill", function(d) { return color(d[0]); })
                .on("mouseover", function(d) {
                        d3.select(this)
                        .transition()
                        .duration(750)
                        .attr("r", 10);
    
                        return tooltip.style("visibility", "visible")
                                      .style("background-color", "lightgray")
                                      .style("color", color(d[0]))
                                      .text(d[0]
                                            + " in "
                                            + d[1].getFullYear()
                                            + ": "
                                            + Math.round(d[2] * 100 * 100) / 100 + "%");
                    })
                .on("mousemove", function() {
                        return tooltip.style("top", (d3.event.pageY - 10) + "px")
                                      .style("left", (d3.event.pageX + 10) + "px");
                    })
                .on("mouseout", function() {
                        d3.select(this)
                        .transition()
                        .duration(750)
                        .attr("r", 5);
                        return tooltip.style("visibility", "hidden");
                    });

                
                d3.select('svg')
                .append('text')
                .attr('id', 'figTitle')
                .text('Debt held by Each Generation')
                .attr('x', 200)
                .attr('y', margin.top)
                .style('font-size', 24);
                
                                    
                d3.select("svg")
                .selectAll("legend")
                .data(legendData)
                .enter()
                .append('text')
                .attr("class", "legend")
                .attr("id" , function(d, i){
                        return "legend" + i;
                    })
                .text(d => d[0])
                .style('fill', function(d) { 
                        return color(d[0]); 
                    })
                .attr('alignment-baseline', 'middle')
                .attr('x', width - 250)
                .attr('y', function(d) {
                        return yScale(d[2] * 100) + 20;
                    })
                    
                d3.selectAll(".line").style("opacity", "0");
                d3.selectAll(".circ").style("opacity", "0");
                d3.selectAll(".legend").style("opacity", "0");
            }
                    
            function animateCircs() 
            {
                d3.selectAll(".circ").style("opacity", "1");
                d3.selectAll(".circ").each(function(d, i)
                {
                    d3.selectAll("#circ" + i)
                    .transition()
                    .duration(5000)
                    .delay(50 * i)
                    .attr("r", 5)
                })
                
                d3.selectAll(".legend").transition().delay(100).style("opacity", "1");
            }
            
            function animatelines()
            {
                animateCircs();
                
                d3.selectAll(".line").style("opacity", "0.5");
                d3.selectAll(".line").each(function(d, i)
                {
                    var totalLength = d3.select("#line" + i).node().getTotalLength();
                    d3.selectAll("#line" + i)
                    .attr("stroke-dasharray", totalLength + " " + totalLength)
                    .attr("stroke-dashoffset", totalLength)
                    .transition()
                    .duration(5000)
                    .delay(100 * i)
                    .attr("stroke-dashoffset", 0)
                    .style("stroke-width", 3)
                })
            }

        </script>
    </body>

</html>

